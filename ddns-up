#!/bin/bash

PIDFILE=/var/run/ddns.pid
LOGFILE=/var/log/ddns-up.log
LOGTIME=$(date "+%Y-%m-%d %H:%M:%S")
LOGIN=
PASS=
FORMAT="json"
DOMID=
RECID=
SUBDOM=
RECLINE="默认"
INTERVAL="120"

if [ -f /var/run/ddns.pid ]; then
  echo "$LOGTIME:  PID file exists. Checking for running process." | tee -a $LOGFILE
  ps up $(cat $PIDFILE) &> /dev/null
  if [ $? -ne 0 ]; then
    echo "$LOGTIME: PID is stale. Remove and restarting." | tee -a $LOGFILE
    rm $PIDFILE
    echo $$ > $PIDFILE
  else
    echo "$LOGTIME: Process is still up and running. Script aborted." | tee -a $LOGFILE
  fi
else
  echo $$ > $PIDFILE
fi

while true; do
  MYIP=$(curl --silent -X POST http://cynovan.com/ip.php | tr -d "\n")
  DOMIP=$(curl --silent -X POST https://dnsapi.cn/Record.Info -d "login_email=$LOGIN&login_password=$PASS&format=$FORMAT&domain_id=$DOMID&record_id=$RECID" | python -mjson.tool | grep value | cut -d: -f2 | tr -d "\"" | tr -d " ")
  if [ $MYIP = $DOMIP ]; then
    echo "IP not changed: $MYIP. Sleeping for 30 seconds." | tee -a $LOGFILE
    sleep $INTERVAL
  else
    echo "IP change detected. Original: $DOMIP -- Updating to: $MYIP " | tee -a $LOGFILE
    curl --silent -X POST https://dnsapi.cn/Record.Ddns -d "login_email=$LOGIN&login_password=$PASS&format=$FORMAT&domain_id=$DOMID&record_id=$RECID&record_line=$RECLINE&sub_domain=$SUBDOM"
    sleep $INTERVAL
  fi
done
