#!/bin/bash

PIDFILE=/var/run/ddns.pid
LOGFILE=/var/log/ddns-up.log
GETIPURL=
LOGIN=
PASS=
DOMAIN=
SUBDOM=
INTERVAL="120"

logtime() { date +"%Y-%m-%d %H:%M:%S" }
action() { curl --silent -X POST $1 }
jsonpretty() { python -mjson.tool }
getip() { action $GETIPURL }
getip_post() { tr -d "\n" }
getinfo() { action $APIURL/Domain.List $QUERY }
getdomid() { jsonpretty | grep -E '\"name\":.*\"$DOMAIN\"' -n5 | grep \"id\" | grep -Eo '[0-9]{4,}' }
getdominfo() { action $APIURL/Record.List $QUERY$RECLIST }
getrecid() { jsonpretty | grep -E '\"name\":.*\"$SUBDOM\"' -n5 | grep \"id\" | grep -Eo '[0-9]{4,}' }
getrecord() { action $APIURL/Record.Info -d $QUERY$DOMINFO }
getrecord_post() { jsonpretty | grep value | cut -d: -f2 | tr -d "\"" | tr -d " " }
updateip() { action $APIURL/Record.Ddns -d $UPDATE }

APIURL="https://dnsapi.cn"
FORMAT="json"
RECLINE="默认"
QUERY="login_email=$LOGIN&login_password=$PASS&format=$FORMAT"
ACCINFO=$(getinfo)
DOMID=$(echo $ACCINFO | getdomid)
RECLIST="&domain_id=$DOMID"
RECID=$(getdominfo | getrecid)
DOMINFO="&domain_id=$DOMID&record_id=$RECID"
UPDATE=$QUERY$DOMINFO"&record_line=$RECLINE&sub_domain=$SUBDOM"

# Check for previously running instances.
# If one exists, see if it's alive.
# If yes, abort. If no, delete stale PID file (if exists) and start the process.
# TODO:
# * To support IPv6 (currently it should favor IPv6 as most systems' default, unless you have
#   tweaked your system to use IPv4 first or IPv6 times out.)
# * Handle situations where another process running under the old PID. Although this is a
#   rare case, but it should be under consideration.

if [ -f $PIDFILE ]; then
  echo "$(logtime) - PID file exists. Checking for running process." | tee -a $LOGFILE
  ps up $(cat $PIDFILE) &> /dev/null
  if [ $? -ne 0 ]; then
    echo "$(logtime) - PID is stale. Remove and starting." | tee -a $LOGFILE
    rm $PIDFILE
    echo $$ > $PIDFILE
  else
    echo "$(logtime) - Process is still up and running. Script aborted." | tee -a $LOGFILE
  fi
else
  echo $$ > $PIDFILE
fi

# Log rotation.
# This part should be replaced by the system logrotate tool.

[ $(echo "$(du $LOGFILE | awk '{ print $1 }') > 4096" | bc) -ne 0 ] &&
  tar -czf $LOGFILE-$(date +%Y%m%d).tar.gz $LOGFILE && rm $LOGFILE && touch $LOGFILE &&
  echo "$(logtime): Last log file was too big (>4M), compressed for archive and creating a new one." >> $LOGFILE

# Non-stop loop for checking the DDNS status.
# It will get the record from DNSPod every $INTERVAL seconds.
# If the record on server is the same as getip()'s result, then sleep for $INTERVAL seconds.
# If not, update the record then sleep.

while true; do
  MYIP=$(getip | getip_post)
  DOMIP=$(getrecord | getrecord_post)
  if [ $MYIP = $DOMIP ]; then
    echo "$(logtime): IP not changed: $MYIP. Sleeping for $INTERVAL seconds." | tee -a $LOGFILE
    sleep $INTERVAL
  else
    echo "$(logtime): IP change detected. Original: $DOMIP -- Updating to: $MYIP " | tee -a $LOGFILE
    updateip
    sleep $INTERVAL
  fi
done
